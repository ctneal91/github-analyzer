#!/bin/sh

# Detect package manager (yarn or npm)
if [ -f "frontend/yarn.lock" ]; then
  PKG_MGR="yarn"
else
  PKG_MGR="npm run"
fi

echo "Using package manager: $PKG_MGR"

echo "=== Step 1: Linting and Type Checking ==="
npx lint-staged

echo "Running frontend TypeScript type check..."
cd frontend
$PKG_MGR typecheck
if [ $? -ne 0 ]; then
  echo "TypeScript type check failed!"
  exit 1
fi
cd ..

echo "=== Step 2: Running RSpec tests with coverage check ==="
bundle exec rspec
# SimpleCov will fail if coverage < 90%

echo "=== Step 3: Running frontend tests with coverage check (90%+ required) ==="
cd frontend
$PKG_MGR test:coverage
# Vitest will fail if coverage < 90%
if [ $? -ne 0 ]; then
  echo "Frontend tests or coverage check failed!"
  exit 1
fi
cd ..

echo "=== All pre-commit checks passed ==="
